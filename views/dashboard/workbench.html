<script type="text/javascript">
    var workbench = new Vue({
        delimiters: ['${', '}'],
        el: "#dashboard-workbench",
        data: {
            themes: {{.Themes }},
            reserveForm: {
                themeId : -1,
                teamName: "路人小队",
                beginTime: "",
                memberCount: "",
                phoneNumber: "",
                newFlag : true,
                showFlag : false
            }, 
            showReservePayFlag:false
        },
    methods: {
        //Reserve function
        startReserve: function(event) {
            var reserveThemeId = event.target.parentNode.attributes["reserve-theme-id"].nodeValue
            var pay_type = "meituan"
            var pay_price = 108
            $.get("/reserve/theme/" + reserveThemeId + "/start?pay_type=" + pay_type + "&pay_price=" + pay_price, function (data, status) {
                $("body").html(data)
            })
        },
        submitReserveForm: function(event) {
            $(event.target).submit(function (e) {
                e.preventDefault();
                $.post("/reserve/theme", $(this).serialize(), function (data, status) {
                    $("body").html(data);
                });
            });
        },
        editReserve : function(event){
            var reserveThemeId = event.target.parentNode.parentNode.attributes["reserve-theme-id"].nodeValue
            this.reserveForm.showFlag = true;
            OUTER:
            for (theme of this.themes){
                for (reserve of theme.Reserves){
                    if (reserve.Id == reserveThemeId){
                        this.reserveForm.themeId = reserve.Theme.Id
                        this.reserveForm.teamName = reserve.TeamName
                        this.reserveForm.beginTime = reserve.BeginTime
                        this.reserveForm.memberCount = reserve.MemberCount
                        this.reserveForm.phoneNumber = reserve.PhoneNumber
                        this.reserveForm.newFlag = false
                        break OUTER
                    }
                }
            }
        },
        deleteReserve: function(event) {
            var reserveThemeId = event.target.parentNode.parentNode.attributes["reserve-theme-id"].nodeValue
            $.get("/reserve/theme/" + reserveThemeId + "/delete", function (data, status) {
                $("body").html(data)
            })
        },
        toggleReservePay: function(event) {
            this.showReservePayFlag = this.showReservePayFlag ? false : true;
        },
        toggleReserveForm: function(event) {
            this.reserveForm.showFlag = this.reserveForm.showFlag ? false:true;
            this.reserveForm.themeId = -1
            this.reserveForm.teamName = "路人小队"
            this.reserveForm.beginTime = ""
            this.reserveForm.memberCount = ""
            this.reserveForm.phoneNumber = ""
            this.reserveForm.newFlag = true;
        },

        //Record function
        tipRecord: function(event) {
            var recordThemeId = event.target.parentNode.parentNode.attributes["record-theme-id"].nodeValue
            console.log(recordThemeId)
            $.get("record/theme/" + recordThemeId + "/tip", function (data, status) {
                $("body").html(data)
            })
        },
        finishRecord: function(event) {
            var recordThemeId = event.target.parentNode.attributes["record-theme-id"].nodeValue
            console.log(recordThemeId)
            $.get("record/theme/" + recordThemeId + "/finish", function (data, status) {
                $("body").html(data)
            })
        },
        unfinishRecord: function(event) {
            var recordThemeId = event.target.parentNode.attributes["record-theme-id"].nodeValue
            console.log(recordThemeId)
            $.get("record/theme/" + recordThemeId + "/unfinish", function (data, status) {
                $("body").html(data)
            })
        },
    }
    })

</script>

<div class="dashboard-workbench" id="dashboard-workbench">
    <button v-on:click="toggleReserveForm" class="btn btn-sm btn-outline-success dashboard-workbench-reserve-form-toggle">+</button>
    <div class="dashboard-workbench-theme" v-bind:class="{blur:reserveForm.showFlag}" v-for="theme of themes" v-bind:theme-id="theme.Id">
        <div class="dashboard-workbench-theme-desc">
            <h3>Theme</h3>
            <div>Title : ${ theme.Theme.Title } </div>
            <div>Desc : ${ theme.Theme.Desc } </div>
            <div>MinMember : ${ theme.Theme.MinMember } </div>
            <div>MaxMember : ${ theme.Theme.MaxMember } </div>
        </div>
        <div class="dashboard-workbench-theme-current" v-bind:record-theme-id="theme.Running.Id" v-if="theme.Running">
            <h3>Playing</h3>
            <div>PayType : ${ theme.Running.PayType } </div>
            <div>PayPrice : ${ theme.Running.PayPrice } </div>
            <div>TipUsed : ${ theme.Running.TipUsed } <button v-on:click="tipRecord" class="btn btn-sm btn-outline-warning"> tip </button></div>
            <div>BeginTime : ${ theme.Running.BeginTime } </div>
            <button v-on:click="finishRecord" class="btn btn-sm btn-outline-warning"> finish </button>
            <button v-on:click="unfinishRecord" class="btn btn-sm btn-outline-warning"> unfinish </button>
        </div>
        <div class="dashboard-workbench-theme-current" v-else>
            <h3>Playing</h3>
            <div>PayType : NULL </div>
            <div>PayPrice : NULL </div>
            <div>TipUsed : NULL </div>
            <div>BeginTime : NULL </div>
        </div>
        <div class="dashboard-workbench-theme-reserves" v-if="theme.Reserves">
            <div class="dashboard-workbench-theme-reserve" v-for="reserve of theme.Reserves" v-bind:reserve-theme-id="reserve.Id">
                <h3 >Reserved
                    <button v-on:click="editReserve" class="btn btn-sm btn-outline-info">E</button>
                    <button v-on:click="deleteReserve" class="btn btn-sm btn-outline-danger">X</button>
                </h3>
                
                <div>TeamName : ${ reserve.TeamName } </div>
                <div>BeginTime : ${ reserve.BeginTime } </div>
                <div>MemberCount : ${ reserve.MemberCount } </div>
                <div>PhoneNumber : ${ reserve.PhoneNumber } </div>
                <button v-on:click="startReserve" class="btn btn-sm btn-outline-primary"> start </button>
                <div style="display:inline;">
                    <button v-on:click="toggleReservePay" class="btn btn-sm btn-outline-primary">pay</button>
                    <div v-if="showReservePayFlag" class="dashboard-workbench-theme-reserve-pay-popup">
                        <div>
                            <label>type:</label>
                            <select name="pay_type">
                                <option value="美团">美团</option>
                                <option value="大众点评">大众点评</option>
                            </select>
                        </div>
                        <div>
                            <label>price:</label>
                            <input type="text" name="pay_price" />
                        </div>
                        <button class="btn btn-primary">submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form class="dashboard-workbench-theme-reserve-form" v-on:submit.prevent="submitReserveForm" v-if="reserveForm.showFlag">
        <button class="btn btn-sm btn-outline-danger" v-on:click="toggleReserveForm">X</button>
        <div class="form-group">
            <label>Theme:</label>
            <select name="theme_id" class="form-control" v-model="reserveForm.themeId">
                <option v-for="theme of themes" v-bind:value="theme.Theme.Id">${ theme.Theme.Title }</option>
            </select>
        </div>
        <div class="form-group">
            <label>TeamName:</label>
            <input class="form-control" type="text" name="team_name" v-model="reserveForm.teamName" />
        </div>
        <div class="form-group">
            <label>BeginTime:</label>
            <input type='text' class="form-control" name="begin_time" v-model="reserveForm.beginTime"/>
        </div>

        <div class="form-group">
            <label>MemberCount:</label>
            <input class="form-control" type="text" name="member_count" v-model="reserveForm.memberCount"/>
        </div>
        <div class="form-group">
            <label>PhoneNumber:</label>
            <input class="form-control" type="text" name="phone_number" v-model="reserveForm.phoneNumber"/>
        </div>
        <input type="submit" class="btn btn-primary" value="new" v-if="reserveForm.newFlag"/>
        <input type="submit" class="btn btn-primary" value="change" v-else/>
    </form>
</div>